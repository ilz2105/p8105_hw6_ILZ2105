---
title: "hw6"
author: "Lulu Zhang"
date: "11/21/2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE)

library(tidyverse)
library(modelr)
library(mgcv)
library(viridis)
library(dplyr)
```
# Problem 1

I will load and tidy the dataset `birthweight` for regression analysis. I converted `frace`, `mrace`, `babysex`, 
and `malform` to factors; confirmed no missing variables; stnadardized variable to the metric system
so i converted `delwt`, `ppwt`, and `wtgain`, from pounds to grams, and `mheight` from inches to cm. 

```{r}
# load data
bwt_data = read.csv("./birthweight.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
   frace = as.factor(frace),
   frace = recode(frace,
    "1" = "White", 
    "2" = "Black", 
    "3" = "Asian", 
    "4" = "Puerto Rican", 
    "8" = "Other", 
    "9" = "Unknown"),
   mrace = as.factor(mrace),
   mrace = recode(mrace, 
    "1" = "White", 
    "2" = "Black", 
    "3" = "Asian", 
    "4" = "Puerto Rican", 
    "8" = "Other"),
   babysex = as.factor(babysex),
   babysex = recode(babysex, 
     "1" = "male", 
    "2" = "female"),
   malform = as.factor(malform),
   malform = recode(malform,
    "0" = "absent", 
    "1" = "present"),
   delwt = 453.592*delwt, 
   ppwt = 453.592*ppwt, 
   wtgain = 453.592*wtgain, 
   mheight = 2.54*mheight)
  
anyNA(bwt_data)
# no missing values

bwt_data
```

Proposing a model for birthweight. I hypothesize `gaweeks`: gestational age in weeks, `pnumlbw`: previous number of low birth weight babies,
`ppbmi`:mother’s pre-pregnancy BMI, `smoken`: average number of cigarettes
smoked per day during pregnancy, and `ppwt`: mother's pre-pregnancy weight are a few of the factors that influence baby's birthweight (outcome). 


```{r include=FALSE}
bwt_model = bwt_data %>% 
  mutate(
    mrace = fct_infreq(mrace)
  ) %>% 
  select(mrace, gaweeks, pnumlbw, ppbmi, smoken, ppwt, bwt)

fit_model = lm(bwt ~ gaweeks + pnumlbw + smoken + ppwt, data = bwt_model)

fit_model %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 4)
```

Testing significance of each hypothesized variable separately, I can look to see if 
the p-value < 0.05, or if there appears to be a linear association in the plots. 

Looking at `mrace`, the p-values are all < 0.05 except for Asian, indicating a significant relationship between mother's race and birthweight. 

```{r}
mrace_model = lm(bwt ~ mrace, data = bwt_model) %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 4)

mrace_model

```

Looking at `gaweeks`, it appears to be significntly associated with bwt looking at the p-values and the graph. 

```{r}
gaweeks_model = lm(bwt ~ gaweeks, data = bwt_model) %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 4)

gaweeks_model 

bwt_model %>% 
  ggplot(aes(x = gaweeks, y = bwt))+
  geom_point()+
  geom_smooth(method = 'lm')
```

Looking at `pnumlbw`, it does not appear to be significantly associated with birthweight. 

```{r}
pnumlbw_model = lm(bwt ~ pnumlbw, data = bwt_model) %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 4)

pnumlbw_model

bwt_model %>% 
  ggplot(aes(x = pnumlbw, y = bwt))+
  geom_point()+
  geom_smooth(method = 'lm')
```

Looking at `ppbmi`, it does appear to be significantly associated with birthweight 
based on the p-values and plot. 

```{r}
ppbmi_model = lm(bwt ~ ppbmi, data = bwt_model) %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 4)

ppbmi_model

bwt_model %>% 
  ggplot(aes(x = ppbmi, y = bwt))+
  geom_point()+
  geom_smooth(method = 'lm')
```

Looking at `smoken`: it does not appear to be significantly associated with birthweight when looking at the plot. 

```{r}
smoken_model = lm(bwt ~ smoken, data = bwt_model) %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 4)

smoken_model

bwt_model %>% 
  ggplot(aes(x = smoken, y = bwt))+
  geom_point()+
  geom_smooth(method = 'lm')
```

Looking at `ppwt`, it does seem to be significantly associated with birthweight. 

```{r}
ppwt_model = lm(bwt ~ ppwt, data = bwt_model) %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 3)

ppwt_model

bwt_model %>% 
  ggplot(aes(x = ppwt, y = bwt))+
  geom_point()+
  geom_smooth(method = 'lm')
```

```{r}
final_model = lm(bwt ~ mrace + gaweeks + ppwt + ppbmi + smoken, data = bwt_model) %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 3)
final_model
```

plot of model residuals against fitted values

```{r}
bwt_resid = bwt_model %>% 
  modelr::add_residuals(fit_model) %>% 
  modelr::add_predictions(fit_model)%>% 
  ggplot(aes(x = pred, y = resid))+
  geom_point()+
  labs(title = "Plot of Model Residuals Against Fitted Values")

bwt_resid
```

Compare your model to two others:

One using length at birth and gestational age as predictors (main effects only)
One using head circumference, length, sex, and all interactions (including the three-way interaction) between these

```{r}
# main effects model

fit_main = lm(bwt ~ blength + gaweeks, data = bwt_data)
fit_main %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  rename(
    "Term" = "term",
    "Estimate" = "estimate",
    "p-value" = "p.value") %>% 
  knitr::kable(digits = 4)

# interactions model
fit_interact = lm(bwt ~ bhead + blength + babysex + bhead * blength + bhead * babysex + blength * babysex +  bhead * blength * babysex, data = bwt_data)
fit_interact %>%
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  rename(
    "Term" = "term",
    "Estimate" = "estimate",
    "p-value" = "p.value") %>% 
  knitr::kable(digits = 4)

# cross validation prediction error

cv = crossv_mc(bwt_data, 100)

cv %>% 
  mutate(
    final_model = map(train, ~lm(bwt ~ mrace + gaweeks + ppwt + ppbmi + smoken, data = bwt_model)),
    fit_main = map(train, ~lm(bwt ~ blength + gaweeks, data = bwt_data)),
    fit_interact = map(train, ~lm(bwt ~ bhead + blength + babysex + bhead * blength + bhead * babysex + blength * babysex +  bhead * blength * babysex, data = bwt_data)),
    rmse_final = map2_dbl(final_model, test, ~rmse(model = .x, data = .y)),
    rmse_main = map2_dbl(fit_main, test, ~rmse(model = .x, data = .y)),
    rmse_interact = map2_dbl(fit_interact, test, ~rmse(model = .x, data = .y))
  )

cv %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model",
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(
    model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse))+
  geom_violin()+
  labs(title = "Cross validated prediction errors")

```


# Problem 2

```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())

weather_df
set.seed(1)
```

Use 5000 bootstrap samples and, for each bootstrap sample, produce estimates of these two quantities. Plot the distribution of your estimates, and describe these in words. Using the 5000 bootstrap estimates, identify the 2.5% and 97.5% quantiles to provide a 95% confidence interval for r^2 and log(β^0∗β^1). Note: broom::glance() is helpful for extracting r^2 from a fitted regression, and broom::tidy() (with some additional wrangling) should help in computing log(β^0∗β^1)

```{r}
weather_bs = weather_df %>% 
  modelr::bootstrap(n = 5000) %>% 
  mutate(
    models = map(strap, ~lm(tmax ~ tmin, data = .x)),
    results = map(models, broom::glance),
   glanced = map(models, broom::glance)) %>% 
  select(-strap, -models) %>%
  unnest() %>% 
  pivot_wider(
    names_from = term,
    values_from = estimate) %>% 
  select(-.id) %>% 
  rename(
    beta0 = `(intercept)`,
    beta1 = tmin) %>% 
  mutate(beta_ln = log(beta0*beta1))
  

```

```{r}
# plot

weather_bs %>% 
  ggplot(aes(x = r.squared))+
  geom_density()+
  labs(title = "")
```

